  <h1>Simulador de Probabilidades</h1>

  <label for="numDados">Número de Dados:</label>
  <input type="number" id="numDados" value="5" /><br><br>

  <label for="valoresAgain">Valores de rerolagem (separados por vírgula):</label>
  <input type="text" id="valoresAgain" placeholder="Ex: 10 or 8,9,10" /><br><br>

  <input type="checkbox" id="checkReroll" />
  <label for="checkReroll">ROTE (reroll results < 7 on first roll)</label><br><br>

  <button onclick="calcularEMostrar()">Calcular</button>

  <h2>Resultados</h2>
  <pre id="resultadosArea"></pre>

  <script>
    function calcularProbabilidade(numDados, numSimulacoes = 500000, again = [], rerollBelow7FirstTime = false) {
      // Para armazenar a contagem de sucessos finais
      const contagemResultados = {};

      let falhasCriticas = 0;

      for (let i = 0; i < numSimulacoes; i++) {
        let sucessos = 0;
        let rolouMaiorQue7 = false;
        let rolouUmaFalha = false;

        // --- Primeira rolagem ---
        // Rola `numDados` uma única vez
        const dadosPrimeiraRolagem = [];
        for (let d = 0; d < numDados; d++) {
          dadosPrimeiraRolagem.push(Math.floor(Math.random() * 10) + 1);
        }

        // Lista para guardar os dados extras que surgirem de "again"
        let dadosExtras = [];

        for (let dado of dadosPrimeiraRolagem) {
          let final = dado;

          // Se ROTE estiver ativo, rerolla resultados abaixo de 7 (somente na primeira rolagem)
          if (rerollBelow7FirstTime && final < 7) {
            final = Math.floor(Math.random() * 10) + 1;
          }

          // Avalia o valor do dado
          if (again.includes(final)) {
            sucessos++;
            rolouMaiorQue7 = true;
            // Acumula "1 dado extra" para rolagem subsequente
            dadosExtras.push(1);
          } else if (final >= 8) {
            sucessos++;
            rolouMaiorQue7 = true;
          } else if (final === 1) {
            rolouUmaFalha = true;
          }
        }

        // --- Rolagens subsequentes (for again) ---
        while (dadosExtras.reduce((a, b) => a + b, 0) > 0) {
          const qtd = dadosExtras.reduce((a, b) => a + b, 0);
          dadosExtras = [];

          for (let j = 0; j < qtd; j++) {
            let dado = Math.floor(Math.random() * 10) + 1;
            if (again.includes(dado)) {
              sucessos++;
              rolouMaiorQue7 = true;
              dadosExtras.push(1);
            } else if (dado >= 8) {
              sucessos++;
              rolouMaiorQue7 = true;
            } else if (dado === 1) {
              rolouUmaFalha = true;
            }
          }
        }

        // Verificar se foi falha crítica (pelo menos um 1 e nenhum sucesso)
        if (rolouUmaFalha && !rolouMaiorQue7) {
          falhasCriticas++;
        }

        // Contabiliza no contagemResultados
        if (contagemResultados[sucessos] === undefined) {
          contagemResultados[sucessos] = 0;
        }
        contagemResultados[sucessos]++;
      }

      // Agora calcula probabilidades
      const probabilidade = {};
      for (let key in contagemResultados) {
        probabilidade[key] = contagemResultados[key] / numSimulacoes;
      }

      // Falha Crítica
      const probabilidadeFalhaCritica = falhasCriticas / numSimulacoes;

      // Probabilidade de falha (<=0 sucessos) — mas removendo a parte que é falha crítica
      let sumFalhasOuMenos = 0;
      for (let resultado in probabilidade) {
        const r = parseInt(resultado, 10);
        if (r <= 0) {
          sumFalhasOuMenos += probabilidade[resultado];
        }
      }
      const probabilidadeFalha = sumFalhasOuMenos - probabilidadeFalhaCritica;

      // Sucesso crítico = 5 ou mais sucessos
      let probabilidadeSucessoCritico = 0;
      for (let resultado in probabilidade) {
        const r = parseInt(resultado, 10);
        if (r >= 5) {
          probabilidadeSucessoCritico += probabilidade[resultado];
        }
      }

      // Sucesso (comum) = 1 - (prob. total de falha + prob. de sucesso crítico)
      const probabilidadeSucesso =
        1 - sumFalhasOuMenos - probabilidadeSucessoCritico;

      return {
        probabilidade,                // distribuição completa
        probabilidadeFalhaCritica,
        probabilidadeFalha,
        probabilidadeSucesso,
        probabilidadeSucessoCritico
      };
    }

    function calcularEMostrar() {
      const numDados = parseInt(document.getElementById("numDados").value, 10);

      // Pegar valores 'again' em uma lista (por ex., "10" ou "8,9,10")
      const rawAgain = document.getElementById("valoresAgain").value.trim();
      let listaAgain = [];
      if (rawAgain) {
        // ex: "8,9,10" -> [8, 9, 10]
        listaAgain = rawAgain
          .split(",")
          .map(x => parseInt(x.trim(), 10))
          .filter(x => !isNaN(x));
      }

      const rerollOption = document.getElementById("checkReroll").checked;

      // Chamar a função de cálculo
      const numSimulacoes = 500000; // Ajuste conforme necessário
      const {
        probabilidade,
        probabilidadeFalhaCritica,
        probabilidadeFalha,
        probabilidadeSucesso,
        probabilidadeSucessoCritico
      } = calcularProbabilidade(numDados, numSimulacoes, listaAgain, rerollOption);

      // Monta a string de resultados
      let resultadosStr = "Distribuição de sucessos:\n";
      // Ordenar as chaves numéricas
      const sortedKeys = Object.keys(probabilidade)
                               .map(k => parseInt(k, 10))
                               .sort((a,b) => a-b);

      for (let key of sortedKeys) {
        resultadosStr += `Resultado ${key}: ${(probabilidade[key]*100).toFixed(2)}%\n`;
      }
      resultadosStr += "\n";
      resultadosStr += `Falha Crítica: ${(probabilidadeFalhaCritica * 100).toFixed(2)}%\n`;
      resultadosStr += `Falha: ${(probabilidadeFalha * 100).toFixed(2)}%\n`;
      resultadosStr += `Sucesso: ${(probabilidadeSucesso * 100).toFixed(2)}%\n`;
      resultadosStr += `Sucesso Crítico (5+): ${(probabilidadeSucessoCritico * 100).toFixed(2)}%\n`;

      document.getElementById("resultadosArea").textContent = resultadosStr;
    }
  </script>
