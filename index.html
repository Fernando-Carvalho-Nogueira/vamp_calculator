<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Vampire the Requiem: Falha Crítica</title>
  <style>
    /* Estilo básico para a página */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #eee;
    }
    header {
      background-color: #600;
      padding: 1rem;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 2em;
      color: #fff;
    }
    main {
      max-width: 600px;
      margin: 2rem auto;
      background-color: #222;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
    }
    h2 {
      color: #c33;
    }
    label {
      display: inline-block;
      margin-top: 0.5rem;
      margin-bottom: 0.2rem;
      font-weight: bold;
    }
    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #333;
      color: #eee;
      font-size: 1rem;
    }
    input[type="checkbox"] {
      margin-right: 0.5rem;
      transform: scale(1.2);
      cursor: pointer;
    }
    button {
      background-color: #900;
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #c00;
    }
    pre {
      background-color: #333;
      padding: 1rem;
      border-radius: 4px;
      white-space: pre-wrap; /* permite quebra de linha automática se precisar */
    }
    footer {
      text-align: center;
      color: #444;
      margin: 2rem 0;
    }
  </style>
</head>
<body>

  <header>
    <h1>Vampire the Requiem: Falha Crítica</h1>
  </header>

  <main>
    <h2>Simulador de Probabilidades</h2>

    <label for="numDados">Número de Dados:</label>
    <input type="number" id="numDados" value="5" />

    <label for="valoresAgain">Valores de rerolagem (separados por vírgula):</label>
    <input type="text" id="valoresAgain" placeholder="Ex: 10 ou 8,9,10" />

    <div style="margin-bottom: 1rem;">
      <input type="checkbox" id="checkReroll" />
      <label for="checkReroll" style="display:inline; font-weight: normal;">
        ROTE (rerrollar dados abaixo de 7 na primeira rolagem)
      </label>
    </div>

    <button onclick="calcularEMostrar()">Calcular</button>

    <h2>Resultados</h2>
    <pre id="resultadosArea"></pre>
  </main>

  <footer>
    <p>Desenvolvido para demonstração de probabilidades.</p>
  </footer>

  <script>
    function calcularProbabilidade(numDados, numSimulacoes = 500000, again = [], rerollBelow7FirstTime = false) {
      const contagemResultados = {};
      let falhasCriticas = 0;

      for (let i = 0; i < numSimulacoes; i++) {
        let sucessos = 0;
        let rolouMaiorQue7 = false;
        let rolouUmaFalha = false;

        // Primeira rolagem
        const dadosPrimeiraRolagem = [];
        for (let d = 0; d < numDados; d++) {
          dadosPrimeiraRolagem.push(Math.floor(Math.random() * 10) + 1);
        }

        let dadosExtras = [];

        for (let dado of dadosPrimeiraRolagem) {
          let final = dado;

          // Rerrollar se < 7 (ROTE) somente na primeira rolagem
          if (rerollBelow7FirstTime && final < 7) {
            final = Math.floor(Math.random() * 10) + 1;
          }

          // Avaliar valor do dado
          if (again.includes(final)) {
            sucessos++;
            rolouMaiorQue7 = true;
            dadosExtras.push(1);
          } else if (final >= 8) {
            sucessos++;
            rolouMaiorQue7 = true;
          } else if (final === 1) {
            rolouUmaFalha = true;
          }
        }

        // Rolagens extras
        while (dadosExtras.reduce((a, b) => a + b, 0) > 0) {
          const qtd = dadosExtras.reduce((a, b) => a + b, 0);
          dadosExtras = [];

          for (let j = 0; j < qtd; j++) {
            let dado = Math.floor(Math.random() * 10) + 1;
            if (again.includes(dado)) {
              sucessos++;
              rolouMaiorQue7 = true;
              dadosExtras.push(1);
            } else if (dado >= 8) {
              sucessos++;
              rolouMaiorQue7 = true;
            } else if (dado === 1) {
              rolouUmaFalha = true;
            }
          }
        }

        // Verificar se foi falha crítica
        if (rolouUmaFalha && !rolouMaiorQue7) {
          falhasCriticas++;
        }

        // Atualiza contagem
        if (contagemResultados[sucessos] === undefined) {
          contagemResultados[sucessos] = 0;
        }
        contagemResultados[sucessos]++;
      }

      // Calcular probabilidades
      const probabilidade = {};
      for (let key in contagemResultados) {
        probabilidade[key] = contagemResultados[key] / numSimulacoes;
      }

      const probabilidadeFalhaCritica = falhasCriticas / numSimulacoes;

      // Prob de falha (<= 0 sucessos) - subtrair a falha crítica
      let sumFalhasOuMenos = 0;
      for (let resultado in probabilidade) {
        const r = parseInt(resultado, 10);
        if (r <= 0) {
          sumFalhasOuMenos += probabilidade[resultado];
        }
      }
      const probabilidadeFalha = sumFalhasOuMenos - probabilidadeFalhaCritica;

      // Sucesso crítico (5 ou + sucessos)
      let probabilidadeSucessoCritico = 0;
      for (let resultado in probabilidade) {
        const r = parseInt(resultado, 10);
        if (r >= 5) {
          probabilidadeSucessoCritico += probabilidade[resultado];
        }
      }

      // Sucesso comum
      const probabilidadeSucesso = 1 - sumFalhasOuMenos - probabilidadeSucessoCritico;

      return {
        probabilidade,
        probabilidadeFalhaCritica,
        probabilidadeFalha,
        probabilidadeSucesso,
        probabilidadeSucessoCritico
      };
    }

    function calcularEMostrar() {
      const numDados = parseInt(document.getElementById("numDados").value, 10);

      const rawAgain = document.getElementById("valoresAgain").value.trim();
      let listaAgain = [];
      if (rawAgain) {
        listaAgain = rawAgain
          .split(",")
          .map(x => parseInt(x.trim(), 10))
          .filter(x => !isNaN(x));
      }

      const rerollOption = document.getElementById("checkReroll").checked;
      const numSimulacoes = 500000; // Ajuste conforme necessário

      const {
        probabilidade,
        probabilidadeFalhaCritica,
        probabilidadeFalha,
        probabilidadeSucesso,
        probabilidadeSucessoCritico
      } = calcularProbabilidade(numDados, numSimulacoes, listaAgain, rerollOption);

      let resultadosStr = "Distribuição de sucessos:\n";
      const sortedKeys = Object.keys(probabilidade)
                               .map(k => parseInt(k, 10))
                               .sort((a,b) => a - b);

      for (let key of sortedKeys) {
        resultadosStr += `Resultado ${key}: ${(probabilidade[key] * 100).toFixed(2)}%\n`;
      }

      resultadosStr += "\n";
      resultadosStr += `Falha Crítica: ${(probabilidadeFalhaCritica * 100).toFixed(2)}%\n`;
      resultadosStr += `Falha: ${(probabilidadeFalha * 100).toFixed(2)}%\n`;
      resultadosStr += `Sucesso: ${(probabilidadeSucesso * 100).toFixed(2)}%\n`;
      resultadosStr += `Sucesso Crítico (5+): ${(probabilidadeSucessoCritico * 100).toFixed(2)}%\n`;

      document.getElementById("resultadosArea").textContent = resultadosStr;
    }
  </script>

</body>
</html>
